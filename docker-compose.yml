services:
  # ============================================================================
  # FRONTEND APPS - Run via pnpm dev (not Docker)
  # ============================================================================
  # Commented out: web, parent-portal, teacher-portal, learner-app
  # These are handled by the monorepo dev task (pnpm dev)

  # ============================================================================
  # CORE SERVICES
  # ============================================================================

  # API Gateway - Enterprise authentication with MFA, SSO, COPPA compliance
  api-gateway:
    build: ./services/api-gateway
    ports:
      - "8001:8001"
    environment:
      - SERVICE_NAME=api-gateway
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@aivo-postgres:5432/aivo_auth
      - REDIS_URL=redis://aivo-redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-super-secret-jwt-key-change-this-in-production-min-32-chars}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - HIBP_API_KEY=${HIBP_API_KEY}
      - LOG_LEVEL=INFO
    networks:
      - default
      - database_aivo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Baseline Assessment - IRT-based adaptive testing
  baseline-assessment:
    build: ./services/baseline-assessment-svc
    ports:
      - "8003:8003"
    environment:
      - SERVICE_NAME=baseline-assessment-svc
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@aivo-postgres:5432/aivo
      - REDIS_URL=redis://aivo-redis:6379/6
      - LOG_LEVEL=INFO
    networks:
      - default
      - database_aivo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Learning Session - Adaptive learning with Bayesian Knowledge Tracing
  learning-session:
    build: ./services/learning-session-svc
    ports:
      - "8004:8004"
    environment:
      - SERVICE_NAME=learning-session-svc
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@aivo-postgres:5432/aivo_learning
      - REDIS_URL=redis://aivo-redis:6379/2
      - BKT_DEFAULT_P_INIT=0.3
      - BKT_DEFAULT_P_LEARN=0.1
      - BKT_DEFAULT_P_GUESS=0.2
      - BKT_DEFAULT_P_SLIP=0.1
      - MASTERY_THRESHOLD=0.8
      - LOG_LEVEL=INFO
    networks:
      - default
      - database_aivo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Focus Monitor - Attention tracking with educational games
  focus-monitor:
    build: ./services/focus-monitor-svc
    ports:
      - "8005:8005"
    environment:
      - SERVICE_NAME=focus-monitor-svc
      - REDIS_URL=redis://aivo-redis:6379/3
      - IDLE_THRESHOLD_MS=30000
      - FOCUS_SCORE_THRESHOLD=0.4
      - LOG_LEVEL=INFO
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Curriculum Content - Comprehensive K-12 content all subjects/systems
  curriculum-content:
    build: ./services/curriculum-content-svc
    ports:
      - "8006:8006"
    environment:
      - SERVICE_NAME=curriculum-content-svc
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@aivo-postgres:5432/aivo_curriculum
      - REDIS_URL=redis://aivo-redis:6379/4
      - AI_PROVIDER=localai
      - LOCALAI_BASE_URL=http://localai:8080
      - OLLAMA_BASE_URL=http://ollama:11434
      - CONTENT_MODEL=llama3.2:3b
      - USE_LOCAL_MODELS=true
      - SUBJECTS=math,science,english,social_studies,languages,arts,pe,cs
      - ENABLE_US_COMMON_CORE=true
      - ENABLE_UK_NATIONAL=true
      - ENABLE_IB=true
      - ENABLE_CHINESE_NATIONAL=true
      - LOG_LEVEL=INFO
    depends_on:
      - localai
      - ollama
    networks:
      - default
      - database_aivo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Homework Helper - Socratic tutoring with OCR (LocalAI-powered)
  homework-helper:
    build: ./services/homework-helper-svc
    ports:
      - "8007:8007"
    environment:
      - SERVICE_NAME=homework-helper-svc
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@aivo-postgres:5432/aivo_homework
      - REDIS_URL=redis://aivo-redis:6379/5
      - AI_PROVIDER=localai
      - LOCALAI_BASE_URL=http://localai:8080
      - OLLAMA_BASE_URL=http://ollama:11434
      - CHAT_MODEL=llama3.2:3b
      - MATH_MODEL=codellama:7b
      - VISION_MODEL=llava:7b
      - USE_LOCAL_MODELS=true
      - GOOGLE_APPLICATION_CREDENTIALS=/app/google-credentials.json
      - GOOGLE_PROJECT_ID=${GOOGLE_PROJECT_ID}
      - TESSERACT_PATH=/usr/bin/tesseract
      - OCR_LANGUAGES=eng
      - OCR_DPI=300
      - HANDWRITING_DETECTION=true
      - MATH_CONFIDENCE_THRESHOLD=0.85
      - ENABLE_LATEX_CONVERSION=true
      - MAX_HINT_LEVEL=6
      - ENABLE_METACOGNITIVE_PROMPTS=true
      - MIN_THINK_TIME_SECONDS=5
      - MAX_FILE_SIZE_MB=10
      - ALLOWED_FILE_TYPES=pdf,png,jpg,jpeg
      - SESSION_TIMEOUT_MINUTES=120
      - CONVERSATION_HISTORY_LIMIT=50
      - MAX_UPLOADS_PER_HOUR=10
      - MAX_CHAT_MESSAGES_PER_MINUTE=20
      - LOG_LEVEL=INFO
    volumes:
      - ./google-credentials.json:/app/google-credentials.json:ro
    networks:
      - default
      - database_aivo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8007/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # IEP Assistant - SMART goal generation and progress tracking
  iep-assistant:
    build: ./services/iep-assistant-svc
    ports:
      - "8008:8008"
    environment:
      - SERVICE_NAME=iep-assistant-svc
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@aivo-postgres:5432/aivo_iep
      - REDIS_URL=redis://aivo-redis:6379/6
      - AI_PROVIDER=localai
      - LOCALAI_BASE_URL=http://localai:8080
      - OLLAMA_BASE_URL=http://ollama:11434
      - IEP_MODEL=llama3.2:3b
      - ANALYSIS_MODEL=codellama:7b
      - USE_LOCAL_MODELS=true
      - ENABLE_SMART_VALIDATION=true
      - MIN_CONFIDENCE_SCORE=0.7
      - MAX_GOALS_PER_AREA=3
      - DATA_COLLECTION_FREQUENCY=weekly
      - TREND_ANALYSIS_MIN_POINTS=3
      - ALERT_THRESHOLD_REGRESSION=-0.15
      - ALERT_THRESHOLD_AT_RISK=0.4
      - ENABLE_FERPA_COMPLIANCE=true
      - ENABLE_IDEA_VALIDATION=true
      - REQUIRE_SIGNATURES=true
      - MAX_GOAL_GENERATIONS_PER_HOUR=20
      - MAX_DATA_POINTS_PER_DAY=100
      - LOG_LEVEL=INFO
    depends_on:
      - localai
      - ollama
    networks:
      - default
      - database_aivo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8008/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # AI AGENT SERVICES
  # ============================================================================

  # Training & Alignment Agent - Responsible AI governance
  training-alignment:
    build: ./services/training-alignment-svc
    ports:
      - "8009:8009"
    environment:
      - SERVICE_NAME=training-alignment-svc
      - DATABASE_URL=${DATABASE_URL:-postgresql://aivo:password@aivo-postgres:5432/aivo}
      - REDIS_URL=${REDIS_URL:-redis://aivo-redis:6379/0}
      - BIAS_THRESHOLD=0.10
      - DRIFT_THRESHOLD=0.15
      - ENABLE_AUTO_RETRAINING=true
      - ENABLE_BIAS_MITIGATION=true
      - LOG_LEVEL=INFO
    networks:
      - default
      - database_aivo-network
    restart: unless-stopped

  # Language Translator Agent - Multi-language support (50+ languages)
  translator:
    build: ./services/translator-svc
    ports:
      - "8010:8010"
    environment:
      - SERVICE_NAME=translator-svc
      - GOOGLE_TRANSLATE_API_KEY=${GOOGLE_TRANSLATE_API_KEY}
      - GOOGLE_CLOUD_TTS_KEY=${GOOGLE_CLOUD_TTS_KEY}
      - REDIS_URL=${REDIS_URL:-redis://aivo-redis:6379/1}
      - LOG_LEVEL=INFO
      - CACHE_TTL=3600
      - ENABLE_AUDIO_TRANSLATION=true
    restart: unless-stopped

  # Business Model Agent - Subscriptions and licensing
  business-model:
    build: ./services/business-model-svc
    ports:
      - "8011:8011"
    environment:
      - SERVICE_NAME=business-model-svc
      - DATABASE_URL=${DATABASE_URL:-postgresql://aivo:password@aivo-postgres:5432/aivo}
      - STRIPE_API_KEY=${STRIPE_API_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - LOG_LEVEL=INFO
      - CHURN_THRESHOLD=0.70
    networks:
      - default
      - database_aivo-network
    restart: unless-stopped

  # Notification Agent - Multi-channel communications
  notification:
    build: ./services/notification-svc
    ports:
      - "8012:8012"
    environment:
      - SERVICE_NAME=notification-svc
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER}
      - FIREBASE_CONFIG=${FIREBASE_CONFIG}
      - REDIS_URL=${REDIS_URL:-redis://aivo-redis:6379/2}
      - LOG_LEVEL=INFO
    restart: unless-stopped

  # Analytics & Insights Agent - Platform analytics
  analytics-insights:
    build: ./services/analytics-insights-svc
    ports:
      - "8013:8013"
    environment:
      - SERVICE_NAME=analytics-insights-svc
      - DATABASE_URL=${DATABASE_URL:-postgresql://aivo:password@aivo-postgres:5432/aivo}
      - REDIS_URL=${REDIS_URL:-redis://aivo-redis:6379/3}
      - LOG_LEVEL=INFO
      - CACHE_TTL=3600
    networks:
      - default
      - database_aivo-network
    restart: unless-stopped

  # ============================================================================
  # ACTUAL AI SERVICES - NOT MOCKS!
  # ============================================================================

  # AIVO Main Brain - Connected to LocalAI (CPU-friendly)
  aivo-brain:
    build: ./services/aivo-brain-svc
    ports:
      - "8014:8014"
    environment:
      - SERVICE_NAME=aivo-brain-svc
      - PORT=8014
      - AI_PROVIDER=localai
      - LOCALAI_BASE_URL=http://localai:8080
      - OLLAMA_BASE_URL=http://ollama:11434
      - PRIMARY_MODEL=llama3.2:3b
      - FALLBACK_MODEL=tinyllama:1.1b
      - EMBEDDING_MODEL=nomic-embed-text
      - USE_LOCAL_MODELS=true
      - REDIS_HOST=aivo-redis
      - REDIS_PORT=6379
      - REDIS_DB=4
      - LOG_LEVEL=INFO
    depends_on:
      - localai
      - ollama
    restart: unless-stopped

  # Model Cloning Service - Creates personalized AI for each student (LocalAI-powered)
  model-cloning:
    build: ./services/model-cloning-svc
    ports:
      - "8002:8002"
    environment:
      - SERVICE_NAME=model-cloning-svc
      - AI_PROVIDER=localai
      - AIVO_BRAIN_URL=http://aivo-brain:8001
      - LOCALAI_BASE_URL=http://localai:8080
      - OLLAMA_BASE_URL=http://ollama:11434
      - CLONING_MODEL=llama3.2:3b
      - PERSONALIZATION_MODEL=codellama:7b
      - USE_LOCAL_MODELS=true
      - REDIS_URL=redis://aivo-redis:6379/5
      - S3_BUCKET=aivo-student-models
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - LOG_LEVEL=INFO
    depends_on:
      - aivo-brain
      - minio
      - localai
      - ollama
    restart: unless-stopped

  # ============================================================================
  # LOCAL AI MODEL SERVICES (For Testing Without API Keys)
  # ============================================================================

  # Ollama - Primary local LLM service (Llama, Mistral, Gemma, etc.)
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 3
    # GPU support - uncomment if NVIDIA GPU is available
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # Ollama Web UI - Interface for managing local models
  ollama-webui:
    image: ghcr.io/open-webui/open-webui:main
    ports:
      - "3000:8080"
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      - WEBUI_SECRET_KEY=your-secret-key-change-this
    volumes:
      - ollama_webui_data:/app/backend/data
    depends_on:
      - ollama
    restart: unless-stopped

  # LocalAI - Alternative local AI with OpenAI-compatible API
  localai:
    build: ./docker/localai
    ports:
      - "8080:8080"
    volumes:
      - localai_models:/models
      - ./docker/localai:/config
    environment:
      - DEBUG=true
      - CONTEXT_SIZE=4096
      - THREADS=4
      - MODELS_PATH=/models
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/readyz"]
      interval: 30s
      timeout: 10s
      retries: 3

  # vLLM - High-performance inference server (optional, for production testing)
  # Disabled by default - requires NVIDIA GPU
  # vllm:
  #   image: vllm/vllm-openai:latest
  #   ports:
  #     - "8081:8000"
  #   environment:
  #     - MODEL_NAME=facebook/opt-125m
  #     - MAX_MODEL_LEN=2048
  #   volumes:
  #     - vllm_cache:/root/.cache/huggingface
  #   restart: unless-stopped
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             count: 1
  #             capabilities: [gpu]

  # ============================================================================
  # INFRASTRUCTURE SERVICES
  # ============================================================================

  # MinIO - S3-compatible storage for models (development only)
  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    restart: unless-stopped

  # NOTE: Using existing aivo-postgres and aivo-redis containers
  # Uncomment below if you need dedicated instances
  # postgres:
  #   image: postgres:15-alpine
  #   ports:
  #     - "5432:5432"
  #   environment:
  #     - POSTGRES_DB=aivo
  #     - POSTGRES_USER=aivo
  #     - POSTGRES_PASSWORD=${DB_PASSWORD:-password}
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U aivo"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # redis:
  #   image: redis:7-alpine
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis_data:/data
  #   command: redis-server --appendonly yes
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 3s
  #     retries: 5

  # Speech Therapy Service
  speech-therapy-svc:
    build: ./services/speech-therapy-svc
    ports:
      - "8016:8016"
    environment:
      - SERVICE_NAME=speech-therapy-svc
      - PORT=8016
      - REDIS_URL=redis://aivo-redis:6379
      - DATABASE_URL=postgresql+asyncpg://aivo:${DB_PASSWORD:-password}@postgres/aivo_speech_therapy
      - API_GATEWAY_URL=http://api-gateway:8001
    networks:
      - default
      - database_aivo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8016/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Social-Emotional Learning Service
  sel-agent-svc:
    build: ./services/sel-agent-svc
    ports:
      - "8015:8015"
    environment:
      - SERVICE_NAME=sel-agent-svc
      - PORT=8015
      - REDIS_URL=redis://aivo-redis:6379
      - DATABASE_URL=postgresql+asyncpg://aivo:${DB_PASSWORD:-password}@postgres/aivo_sel
      - API_GATEWAY_URL=http://api-gateway:8001
    networks:
      - default
      - database_aivo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8015/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
  ollama_data:
    driver: local
  ollama_webui_data:
    driver: local
  localai_models:
    driver: local
  localai_data:
    driver: local
  vllm_cache:
    driver: local

networks:
  default:
    name: aivo-network
    external: true
  database_aivo-network:
    external: true
